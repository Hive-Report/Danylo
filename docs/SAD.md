# Software Architecture Documentation

**Проєкт**: uspacy-data-feeder  
**Версія документа**: 0.1  
**Дата**: 04.08.2025  
**Автор**: [Олександр Бажин](https://github.com/OleksandrBazhyn)

---

## 1. Огляд системи

`uspacy-data-feeder` — сервіс для автоматичного збору, перевірки та оновлення інформації про сертифікати КЕП (кваліфікований електронний підпис) та стану ліцензій на програмне забезпечення M.E.Doc стосовно компаній в системі CRM Uspacy.

Мета — забезпечити актуальність даних в CRM по клієнту, автоматизувати додавання нових записів, спростити контроль за діючими сертифікатами, ліцензіями та забезпечити розробникам можливість ручного втручання у виняткових випадках.

---

## 2. Функціональні вимоги

| №  | Вимога                                      | Опис |
|----|---------------------------------------------|------|
| F1 | Збір даних по всім компаніям                | Реалізувати можливість автоматичного отримання інформації для всіх компаній в CRM. |
| F2 | Webhook при створені нової компанії                  | Якщо в Uspacy додається нова компанія — обролювати вхідний Webhook задля забезпечення актуальної інформації в CRM. |
| F3 | Webhook при зміні етапу угоди                   | Якщо в Uspacy змінюється етап угоди — обролювати вхідний Webhook задля забезпечення актуальної інформації в CRM. Необхідно відфільтрувати відповідні Webhook. |
| F4 | Періодичне оновлення інформації                    | Запуск оновлення даних для компаній, ліцензії/сертифікати яких наближаються до закінчення. |
| F5 | Видалення неактуальних КЕП                 | Якщо сертифікат прострочено або має статус "Скасований", він видаляється з CRM при оновленні інформації. |
| F6 | Повне оновлення по всім компаніям          | Можливість запускати періодичне оновлення даних по всім компаніям незалежно від стану. |
| F7 | Перевірка дублювання                        | Якщо в Uspacy вже є аналогічний КЕП, не оновлювати його повторно. |
| F8 | Створення нових залежних сутностей замість оновлення       | Стара інформація видаляється, нова створюється як новий об’єкт. Йдеться про сутність, яка відображає інформацію про сертифікат КЕП або стан ліцензії.  |
| F9| Резервне джерело інформації                 | Якщо основний API недоступний — використовувати альтернативне джерело. |
| F10| Майбутнє розширення                         | Підтримка інших типів даних (не лише КЕП). |

---

## 3. Нефункціональні вимоги

| №   | Вимога             | Опис |
|-----|--------------------|------|
| NF1 | Надійність         | Сервіс має гарантувати повну обробку всіх даних — недообробка недопустима. |
| NF2 | Швидкодія          | Оновлення має проходити у визначений період часу без суттєвих затримок. |
| NF3 | Валідація          | Перед оновленням чи створенням КЕП дані проходять сувору валідацію. |
| NF4 | Масштабованість    | Архітектура має дозволяти масштабування в разі збільшення кількості компаній або джерел даних. |
| NF5 | Тестованість       | Увесь код має бути покритий unit та інтеграційними тестами. |
| NF6 | Спостережуваність  | Сервіс має мати логування, метрики обробки та алерти у разі помилок. |
| NF7 | Інтероперабельність| Взаємодія з CRM Uspacy через webhook, REST API або інші засоби. |
| NF8 | Безпека            | Доступ до API та CRM — тільки через захищені канали з авторизацією. |

---

## 4. Архітектура системи (огляд)

![System Architecture Diagram](pictures/System%20Architecture%20diagram.png)

## 5. Ролі компонентів

- **Scheduler** — запускає періодичне оновлення.
- **Webhook Reciever** — приймає Webhook повідомлення.
- **New Company Controller** — формує задачу по новій компанії.
- **Deal Stage Changed Controller** — формує задачу при зміні етапу угоди.
- **Queue** — черга задач для Update Worker.
- **Update Worker** — оновлює інформацію в CRM.
- **Uspacy Client** — набір методів для взаємодії з Uspacy.
- **Uakey Client** — набір методів для взаємодії з Certs Client.
- **Medoc Client** — набір методів для взаємодії з Uakey and M.E.Doc License Data Parser.
- **Uspacy Token Manager** — контролює стан ключа доступу до ресурсу Uspacy.
- **Google Token Manager** — контролює стан ключа доступу до ресурсів по Google OAuth.
- **Certs Client** — сервіс для отримання інформації по сертифікатам КЕП ЦСК "Україна".
- **Uakey and M.E.Doc License Data Parser** — парсер даних по web-ресурсах ЦСК "Україна" та M.E.Doc.

---

## 6. Потенційне розширення

- Додати підтримку функціоналу для відслідковування інформації для належного супроводу клієнта.
- Розробити методологію для оцінки приналежності клієнта до нас.
- Підтримка кількох CRM (через абстракцію з’єднання).
- Оптимізувати кількість запитів до зовнішніх API  до необхідного мінімуму.

---